<!doctype html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–¢—Ä–µ–Ω–∞–∂–µ—Ä –ø–∞–º º—è—Ç—ñ ‚Äî –ø–æ—Ä—è–¥–æ–∫ –∫–æ–ª—å–æ—Ä—ñ–≤</title>
  <style>
    :root{
      --bg:#f4f5f7; --card:#fff; --txt:#111; --muted:#666;
      --accent:#0a5fa5; --shadow:0 8px 24px rgba(0,0,0,.08);
      --radius:14px; --ok:#39b36b; --bad:#ff4b4b; --top:#2f2f2f;
    }
    *{box-sizing:border-box;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
    body{margin:0;background:var(--bg);color:var(--txt)}
    .wrap{max-width:980px;margin:0 auto;padding:18px}
    .screen{display:none}
    .screen.active{display:block}
    .card{margin-top:14px;background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);padding:18px}
    .center{text-align:center}
    .h1{font-size:26px;margin:2px 0 8px}
    .sub{color:var(--muted);margin:0 0 14px;line-height:1.35}

    .topbar{
      height:46px;background:var(--top);color:#fff;
      display:flex;align-items:center;justify-content:space-between;
      padding:0 14px;border-radius:12px;box-shadow:var(--shadow);gap:10px;
    }
    .top-left,.top-mid,.top-right{display:flex;align-items:center;gap:14px;font-size:14px}
    .pill{display:flex;align-items:center;gap:8px;opacity:.95}
    .pill b{font-weight:700}
    .btn-icon{
      width:30px;height:30px;border-radius:9px;border:0;
      background:rgba(255,255,255,.10);color:#fff;cursor:pointer;
      display:grid;place-items:center;font-weight:800;
    }
    .btn-icon:hover{background:rgba(255,255,255,.18)}

    .form{max-width:420px;margin:0 auto;display:grid;gap:10px;text-align:left}
    label{font-size:13px;color:var(--muted)}
    input{
      width:100%;padding:12px;border-radius:12px;border:1px solid #d9dde3;
      outline:none;font-size:15px;
    }
    input:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(10,95,165,.12)}

    .btn{border:0;border-radius:12px;padding:12px 14px;font-weight:700;cursor:pointer;font-size:15px}
    .btn.primary{background:var(--accent);color:#fff}
    .btn.primary:hover{filter:brightness(.95)}
    .btn.ghost{background:#eef2f7;color:#111}
    .btn.ghost:hover{filter:brightness(.98)}
    .row{display:flex;gap:10px;justify-content:center;flex-wrap:wrap}

    .tag{font-size:12px;font-weight:800;padding:6px 10px;border-radius:999px;background:#eef2f7;color:#111}
    .tag.blue{background:rgba(10,95,165,.12);color:#0a5fa5}
    .tag.green{background:rgba(57,179,107,.12);color:#1f7e45}

    .phase{font-size:14px;color:var(--muted);display:flex;justify-content:center;gap:10px;align-items:center;margin-bottom:10px}
    .stack-area{display:flex;justify-content:center;align-items:center;padding:18px 10px;min-height:320px}

    .stack{
      width:min(300px, 88vw);
      border-radius:14px;overflow:hidden;
      box-shadow:0 10px 30px rgba(0,0,0,.08);
      border:1px solid #e7eaf0;background:#fff;
      position:relative;
    }
    .bar{
      height:56px;
      display:flex;align-items:center;justify-content:center;
      user-select:none;
      position:relative;
      transition: background-color .18s ease, transform .12s ease;
      touch-action:none; /* –≤–∞–∂–ª–∏–≤–æ –¥–ª—è –º–æ–±—ñ–ª—å–Ω–æ–≥–æ drag */
    }
    .bar.grabbable{cursor:grab}
    .bar.disabled{cursor:default}
    .bar.dragging{opacity:.85; transform: scale(1.02)}
    .bar.checked.correct{background: var(--ok) !important}
    .bar.checked.wrong{background: var(--bad) !important}

    .mark{
      position:absolute;width:34px;height:34px;border-radius:999px;
      display:grid;place-items:center;font-weight:900;font-size:18px;
      right:10px;top:50%;transform:translateY(-50%);
      color:#fff;background:rgba(0,0,0,.22);backdrop-filter: blur(2px);
      opacity:0;transition: opacity .12s ease;pointer-events:none;
    }
    .bar.checked .mark{opacity:1}

    .placeholder{
      height:56px;
      border:2px dashed rgba(0,0,0,.18);
      background:rgba(0,0,0,.04);
    }
    .ghost{
      position:fixed; left:0; top:0;
      width:min(300px, 88vw);
      height:56px;
      z-index:9999;
      pointer-events:none;
      box-shadow:0 14px 30px rgba(0,0,0,.18);
      transform: translate(-9999px,-9999px);
    }

    .small{font-size:12px;color:var(--muted)}
  </style>
</head>
<body>
  <div class="wrap">

    <!-- START -->
    <section id="startScreen" class="screen active">
      <div class="card center">
        <div class="h1">–¢—Ä–µ–Ω–∞–∂–µ—Ä –ø–∞–º º—è—Ç—ñ</div>
        <p class="sub">
          6 —Å–µ–∫—É–Ω–¥ –Ω–∞ –∑–∞–ø–∞–º º—è—Ç–æ–≤—É–≤–∞–Ω–Ω—è. –ü–æ—Ç—ñ–º –ø–µ—Ä–µ—Ç—è–≥–Ω—ñ—Ç—å —Å–º—É–∂–∫–∏ –ø–∞–ª—å—Ü–µ–º/–º–∏—à–∫–æ—é –π –Ω–∞—Ç–∏—Å–Ω—ñ—Ç—å ¬´–ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏¬ª.
          –ü—ñ—Å–ª—è –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ 3 —Å–µ–∫—É–Ω–¥–∏ –≤–∏–¥–Ω–æ ‚úì/‚úï —ñ –æ–¥—Ä–∞–∑—É –Ω–∞—Å—Ç—É–ø–Ω–∏–π —Ä—ñ–≤–µ–Ω—å. –ì—Ä–∞ –ù–ï –∑—É–ø–∏–Ω—è—î—Ç—å—Å—è –Ω–∞ –ø–æ–º–∏–ª—Ü—ñ.
        </p>

        <form id="startForm" class="form" autocomplete="on">
          <div>
            <label for="name">–Ü–º º—è</label>
            <input id="name" required maxlength="40" />
          </div>
          <div>
            <label for="email">–ü–æ—à—Ç–∞</label>
            <input id="email" type="email" required maxlength="80" />
          </div>
          <button class="btn primary" type="submit">–ü–æ—á–∞—Ç–∏ –≥—Ä—É</button>
          <div class="small center">–î–∞–Ω—ñ –∑–±–µ—Ä—ñ–≥–∞—é—Ç—å—Å—è –ª–∏—à–µ —É –≤–∞—à–æ–º—É –±—Ä–∞—É–∑–µ—Ä—ñ (localStorage).</div>
        </form>
      </div>
    </section>

    <!-- GAME -->
    <section id="gameScreen" class="screen">
      <div class="topbar">
        <div class="top-left"><div class="pill">–ë–∞–ª–∏: <b id="score">0</b></div></div>
        <div class="top-mid"><div class="pill">–†—ñ–≤–µ–Ω—å: <b id="levelLabel">1/5</b></div></div>
        <div class="top-right"><button class="btn-icon" id="btnExit" title="–í–∏–π—Ç–∏">‚úï</button></div>
      </div>

      <div class="card center">
        <div style="font-weight:800;margin:6px 0 10px">–í—ñ–¥—Å–æ—Ä—Ç—É–π—Ç–µ –∫–æ–ª—å–æ—Ä–∏</div>

        <div class="phase">
          <span class="tag blue" id="phaseTag">–ó–∞–ø–∞–º º—è—Ç–∞–π—Ç–µ –ø–æ—Ä—è–¥–æ–∫</span>
          <span class="tag" id="phaseHint">6</span>
        </div>

        <div class="stack-area">
          <div class="stack" id="stack"></div>
        </div>

        <div class="row">
          <button class="btn primary" id="btnCheck" type="button" style="display:none">–ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏</button>
        </div>

        <div class="small" style="margin-top:10px">–ë–∞–ª–∏: +5 –∑–∞ –∫–æ–∂–Ω—É —Å–º—É–∂–∫—É –Ω–∞ –ø—Ä–∞–≤–∏–ª—å–Ω—ñ–π –ø–æ–∑–∏—Ü—ñ—ó.</div>
      </div>
    </section>

    <!-- RESULT -->
    <section id="resultScreen" class="screen">
      <div class="card center">
        <div class="h1">–†–µ–∑—É–ª—å—Ç–∞—Ç</div>
        <p class="sub" id="resultHello">–ì—Ä—É –∑–∞–≤–µ—Ä—à–µ–Ω–æ.</p>

        <div class="row" style="margin-top:14px">
          <button class="btn primary" id="btnPlayAgain" type="button">–ó—ñ–≥—Ä–∞—Ç–∏ —â–µ —Ä–∞–∑</button>
          <button class="btn ghost" id="btnBackHome" type="button">–ù–∞ –≥–æ–ª–æ–≤–Ω—É</button>
        </div>

        <div class="small" style="margin-top:10px">–Ø–∫—â–æ –≤ Telegram –Ω–µ –ø—Ä–∏–π—à–ª–æ ‚Äî –Ω–∞–ø–∏—à–∏ –±–æ—Ç—É /start.</div>
      </div>
    </section>

  </div>

  <div id="ghost" class="ghost"></div>

  <script>
    // ===== –¢–í–û–á –î–ê–ù–Ü (—è–∫ —Ç–∏ –ø—Ä–æ—Å–∏–ª–∞) =====
    const BOT_TOKEN = "8334284872:AAERmb4ewIUBrVR22xCiM30WEejhyPUlxIY";
    const CHAT_ID   = "1350269784";

    // ===== –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –≥—Ä–∏ =====
    const TOTAL_LEVELS = 5;
    const MEM_SECONDS = 6;
    const SHOW_RESULT_MS = 3000;
    const POINTS_PER_CORRECT = 5;

    // –∞–Ω—Ç–∏-‚Äú—Å—Ö–æ–∂—ñ‚Äù –∫–æ–ª—å–æ—Ä–∏ –≤ –º–µ–∂–∞—Ö –æ–¥–Ω–æ–≥–æ —Ä—ñ–≤–Ω—è
    const MIN_DIST_ANY = 120; // –º—ñ–∂ –±—É–¥—å-—è–∫–∏–º–∏ –¥–≤–æ–º–∞ –∫–æ–ª—å–æ—Ä–∞–º–∏ –≤ —Ä—ñ–≤–Ω—ñ
    const MIN_DIST_ADJ = 160; // –º—ñ–∂ —Å—É—Å—ñ–¥–∞–º–∏

    function barsCountForLevel(lvl){ return Math.min(2 + lvl, 6); }

    // ===== UI =====
    const startScreen = document.getElementById('startScreen');
    const gameScreen  = document.getElementById('gameScreen');
    const resultScreen= document.getElementById('resultScreen');

    const startForm = document.getElementById('startForm');
    const inName = document.getElementById('name');
    const inEmail= document.getElementById('email');

    const scoreEl = document.getElementById('score');
    const levelLabelEl = document.getElementById('levelLabel');

    const phaseTag = document.getElementById('phaseTag');
    const phaseHint= document.getElementById('phaseHint');
    const stackEl  = document.getElementById('stack');

    const btnCheck = document.getElementById('btnCheck');
    const btnExit = document.getElementById('btnExit');

    const resultHello = document.getElementById('resultHello');
    const btnPlayAgain = document.getElementById('btnPlayAgain');
    const btnBackHome  = document.getElementById('btnBackHome');

    const ghostEl = document.getElementById('ghost');

    // ===== State =====
    let player = { name:'', email:'' };
    let level = 1;
    let score = 0;

    let target = [];
    let current = [];
    let phase = 'memorize'; // memorize | restore | locked

    let memorizeTimer = null;
    let memorizeLeft = MEM_SECONDS;

    let levelsChecked = 0;
    let posTotal = 0;
    let posCorrect = 0;
    let startTimestamp = 0;

    // ===== Helpers =====
    function showScreen(which){
      [startScreen, gameScreen, resultScreen].forEach(s => s.classList.remove('active'));
      which.classList.add('active');
    }
    function shuffle(arr){
      const a = arr.slice();
      for(let i=a.length-1;i>0;i--){
        const j = Math.floor(Math.random()*(i+1));
        [a[i],a[j]] = [a[j],a[i]];
      }
      return a;
    }
    function updateTopbar(){
      scoreEl.textContent = String(score);
      levelLabelEl.textContent = `${level}/${TOTAL_LEVELS}`;
    }

    // ===== Color utils =====
    function hexToRgb(hex){
      const h = hex.replace("#","").trim();
      const x = parseInt(h.length === 3 ? h.split("").map(c=>c+c).join("") : h, 16);
      return { r:(x>>16)&255, g:(x>>8)&255, b:x&255 };
    }
    function colorDist(aHex, bHex){
      const a = hexToRgb(aHex), b = hexToRgb(bHex);
      const dr = a.r - b.r, dg = a.g - b.g, db = a.b - b.b;
      return Math.sqrt(dr*dr + dg*dg + db*db);
    }
    function palette(){
      return [
        "#E53935","#D81B60","#8E24AA","#5E35B1","#3949AB",
        "#1E88E5","#039BE5","#00ACC1","#00897B","#43A047",
        "#7CB342","#C0CA33","#FDD835","#FFB300","#FB8C00",
        "#F4511E","#6D4C41","#546E7A","#26C6DA","#66BB6A",
        "#AB47BC","#EC407A","#42A5F5","#26A69A"
      ];
    }
    function sampleUniqueNonSimilarColors(count){
      let pal = shuffle(palette().slice());
      const picked = [];
      for(const c of pal){
        if(picked.length >= count) break;
        let ok = true;
        for(const p of picked){
          if(colorDist(p, c) < MIN_DIST_ANY){ ok = false; break; }
        }
        if(ok) picked.push(c);
      }
      if(picked.length < count){
        const rest = pal.filter(x => !picked.includes(x));
        while(picked.length < count && rest.length) picked.push(rest.shift());
      }
      return picked.slice(0,count);
    }
    function arrangeNonSimilarOrder(colors){
      let best = null, bestMin = -1;
      for(let t=0; t<2500; t++){
        const cand = shuffle(colors);
        let minAdj = Infinity;
        let ok = true;
        for(let i=1;i<cand.length;i++){
          const d = colorDist(cand[i-1], cand[i]);
          minAdj = Math.min(minAdj, d);
          if(d < MIN_DIST_ADJ){ ok = false; break; }
        }
        if(ok) return cand;
        if(minAdj > bestMin){ bestMin = minAdj; best = cand; }
      }
      return best || colors;
    }
    function makeLevelBars(lvl){
      const n = barsCountForLevel(lvl);
      const picked = sampleUniqueNonSimilarColors(n);
      const ordered = arrangeNonSimilarOrder(picked);
      return ordered.map((hex, idx) => ({ id: `${lvl}-${idx}-${hex}`, hex }));
    }

    // ===== Render =====
    function renderBars(list, interactive){
      stackEl.innerHTML = "";
      list.forEach((item) => {
        const div = document.createElement('div');
        div.className = 'bar' + (interactive ? ' grabbable' : ' disabled');
        div.style.background = item.hex;
        div.dataset.id = item.id;
        div.dataset.hex = item.hex;

        const mark = document.createElement('div');
        mark.className = 'mark';
        div.appendChild(mark);

        stackEl.appendChild(div);
      });

      if(interactive) enableMobileDrag();
      else disableMobileDrag();
    }

    function lockInteraction(){
      phase = 'locked';
      btnCheck.disabled = true;
      disableMobileDrag();
      [...stackEl.children].forEach(el => el.classList.add('disabled'));
    }

    function applyCheckVisualsAndScore(){
      const nodes = [...stackEl.children];
      let correctHere = 0;

      for(let i=0;i<nodes.length;i++){
        const ok = current[i].id === target[i].id;
        if(ok) correctHere++;

        const el = nodes[i];
        el.classList.add('checked');
        el.classList.toggle('correct', ok);
        el.classList.toggle('wrong', !ok);

        const m = el.querySelector('.mark');
        if(m) m.textContent = ok ? "‚úì" : "‚úï";
      }

      score += correctHere * POINTS_PER_CORRECT;
      updateTopbar();

      levelsChecked++;
      posTotal += nodes.length;
      posCorrect += correctHere;
    }

    // ===== Mobile drag =====
    let draggingEl = null;
    let placeholderEl = null;
    let pointerId = null;

    function disableMobileDrag(){
      stackEl.onpointerdown = null;
      stackEl.onpointermove = null;
      stackEl.onpointerup = null;
      stackEl.onpointercancel = null;
    }

    function enableMobileDrag(){
      disableMobileDrag();

      stackEl.onpointerdown = (e) => {
        if(phase !== 'restore') return;
        const bar = e.target.closest('.bar');
        if(!bar) return;

        pointerId = e.pointerId;
        stackEl.setPointerCapture(pointerId);

        draggingEl = bar;

        placeholderEl = document.createElement('div');
        placeholderEl.className = 'placeholder';
        bar.replaceWith(placeholderEl);

        ghostEl.style.background = bar.dataset.hex;
        ghostEl.style.width = stackEl.getBoundingClientRect().width + "px";
        ghostEl.style.transform = `translate(${e.clientX - ghostEl.offsetWidth/2}px, ${e.clientY - 28}px)`;

        bar.classList.add('dragging');
        e.preventDefault();
      };

      stackEl.onpointermove = (e) => {
        if(!draggingEl || e.pointerId !== pointerId) return;

        ghostEl.style.transform = `translate(${e.clientX - ghostEl.offsetWidth/2}px, ${e.clientY - 28}px)`;

        const nodes = [...stackEl.querySelectorAll('.bar, .placeholder')];
        const y = e.clientY;

        let insertBefore = null;
        for(const node of nodes){
          const r = node.getBoundingClientRect();
          if(y < r.top + r.height/2){ insertBefore = node; break; }
        }

        if(insertBefore) stackEl.insertBefore(placeholderEl, insertBefore);
        else stackEl.appendChild(placeholderEl);
      };

      const finish = (e) => {
        if(!draggingEl || e.pointerId !== pointerId) return;

        placeholderEl.replaceWith(draggingEl);
        ghostEl.style.transform = `translate(-9999px,-9999px)`;
        draggingEl.classList.remove('dragging');

        const ids = [...stackEl.querySelectorAll('.bar')].map(el => el.dataset.id);
        current = ids.map(id => current.find(x => x.id === id));

        draggingEl = null;
        placeholderEl = null;
        pointerId = null;
      };

      stackEl.onpointerup = finish;
      stackEl.onpointercancel = finish;
    }

    // ===== Phases =====
    function stopMemorizeTimer(){
      if(memorizeTimer){ clearInterval(memorizeTimer); memorizeTimer = null; }
    }

    function setPhaseMemorize(){
      phase = 'memorize';
      phaseTag.textContent = "–ó–∞–ø–∞–º º—è—Ç–∞–π—Ç–µ –ø–æ—Ä—è–¥–æ–∫";
      phaseTag.className = "tag blue";

      memorizeLeft = MEM_SECONDS;
      phaseHint.textContent = String(memorizeLeft);

      btnCheck.style.display = "none";
      btnCheck.disabled = false;

      stopMemorizeTimer();
      memorizeTimer = setInterval(() => {
        memorizeLeft--;
        phaseHint.textContent = String(Math.max(0, memorizeLeft));
        if(memorizeLeft <= 0){
          stopMemorizeTimer();
          setPhaseRestore();
        }
      }, 1000);
    }

    function setPhaseRestore(){
      phase = 'restore';
      phaseTag.textContent = "–í—ñ–¥–Ω–æ–≤—ñ—Ç—å –ø–æ—Ä—è–¥–æ–∫";
      phaseTag.className = "tag green";
      phaseHint.textContent = "–ù–∞—Ç–∏—Å–Ω—ñ—Ç—å ¬´–ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏¬ª";

      current = shuffle(target);
      renderBars(current, true);

      btnCheck.style.display = "inline-block";
      btnCheck.disabled = false;
    }

    // ===== Telegram send (–Ω–∞–ø—Ä—è–º—É) =====
    function sendResultToTelegram(text){
      fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ chat_id: CHAT_ID, text })
      })
      .then(r => r.json())
      .then(d => { if(!d.ok) console.log("Telegram error:", d); })
      .catch(err => console.log("Telegram send failed:", err));
    }

    // ===== Flow =====
    function beginLevel(){
      updateTopbar();
      target = makeLevelBars(level);
      current = target.slice();
      renderBars(target, false);
      setPhaseMemorize();
    }

    function onCheck(){
      if(phase !== 'restore') return;

      lockInteraction();
      applyCheckVisualsAndScore();

      setTimeout(() => {
        level++;
        if(level > TOTAL_LEVELS) finishGame();
        else beginLevel();
      }, SHOW_RESULT_MS);
    }

    function finishGame(){
      stopMemorizeTimer();
      const elapsed = Math.round((Date.now() - startTimestamp)/1000);
      const acc = posTotal === 0 ? 0 : Math.round((posCorrect / posTotal) * 100);

      resultHello.textContent = `–î—è–∫—É—é, ${player.name}! –ì—Ä—É –∑–∞–≤–µ—Ä—à–µ–Ω–æ.`;
      showScreen(resultScreen);

      const text =
`üéÆ –†–ï–ó–£–õ–¨–¢–ê–¢ –¢–†–ï–ù–ê–ñ–ï–†–ê

üë§ –Ü–º º—è: ${player.name}
üìß –ü–æ—à—Ç–∞: ${player.email}

‚≠ê –ë–∞–ª–∏: ${score}
üèÅ –†—ñ–≤–Ω—ñ–≤: ${TOTAL_LEVELS}/${TOTAL_LEVELS}

‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–∏—Ö –ø–æ–∑–∏—Ü—ñ–π: ${posCorrect}/${posTotal}
üéØ –¢–æ—á–Ω—ñ—Å—Ç—å (–ø–æ–∑–∏—Ü—ñ—ó): ${acc}%
üîÅ –ü–µ—Ä–µ–≤—ñ—Ä–æ–∫ (—Ä—ñ–≤–Ω—ñ–≤): ${levelsChecked}

‚è± –ß–∞—Å (—Å–µ–∫): ${elapsed}`;

      sendResultToTelegram(text);
    }

    function resetGame(){
      level = 1;
      score = 0;
      levelsChecked = 0;
      posTotal = 0;
      posCorrect = 0;
      startTimestamp = Date.now();
      updateTopbar();
      beginLevel();
    }

    // ===== Events =====
    startForm.addEventListener('submit', (e) => {
      e.preventDefault();
      player.name = (inName.value || "").trim();
      player.email = (inEmail.value || "").trim();
      if(!player.name || !player.email) return;

      localStorage.setItem("trainer_name", player.name);
      localStorage.setItem("trainer_email", player.email);

      showScreen(gameScreen);
      resetGame();
    });

    btnCheck.addEventListener('click', onCheck);

    btnExit.addEventListener('click', () => {
      stopMemorizeTimer();
      showScreen(startScreen);
    });

    btnPlayAgain.addEventListener('click', () => {
      showScreen(gameScreen);
      resetGame();
    });

    btnBackHome.addEventListener('click', () => {
      showScreen(startScreen);
    });

    (function prefill(){
      const n = localStorage.getItem("trainer_name") || "";
      const e = localStorage.getItem("trainer_email") || "";
      if(n) inName.value = n;
      if(e) inEmail.value = e;
    })();
  </script>
</body>
</html>
